<head>

  <script language="JavaScript" type="text/javascript" src="flotr-0.1.0alpha.js"></script>
  <script language="JavaScript" type="text/javascript" src="calculation.js"></script>
  <link href="jquery-ui.css" rel="stylesheet" type="text/css"/>
  <script language="JavaScript" type="text/javascript" src="jquery-1.6.2.min.js"></script>
  <script language="JavaScript" type="text/javascript" src="jquery-ui-1.8.16.custom.min.js"></script>
  <script language="JavaScript" type="text/javascript" src="prototype-1.6.0.2.js"></script>
 
 <script>
     jQuery.noConflict();
 </script>


<title>How Fscked is My Consistency?</title>
<link rel=StyleSheet href="consistency.css" type="text/css">

</head>

<body>

<h1>How Fscked is My Consistency?</h1>

<center>
<table cellpadding=10px align="center">
<tr>
<td>
<center>
  <span class="graph-label">P(Consistency)</span>
  <div id="tcdf" style="width:700px;height:250px;"></div>
    <span class="big-axis-label">Time After Commit (ms)</span><br/>
</center>
</td>
<td>
<div id="nrwpanel">
<b>Replica Configuration</b><br/><br/>
<span class="slidewraplt">N:</span> <div class="jqslider" id="n-jsslider"></div><span class="slidewraprt" id="Nslider">3</span><br>
<span class="slidewraplt">R:</span> <div class="jqslider" id="r-jsslider"></div><span class="slidewraprt" id="Rslider">1</span><br>
<span class="slidewraplt">W:</span> <div class="jqslider" id="w-jsslider"></div><span class="slidewraprt" id="Wslider">1</span><br>
Avg. Read Latency: <span id="rlatency"></span> ms<br>
Avg. Write Latency: <span id="wlatency"></span> ms<br>
<hr>
<b>Version Drift</b><br>
<span class="slidewraplt">&nbsp;</span> <div class="jqslider" id="k-jsslider"></div><span class="slidewraprt" id="kslider">1</span><br>
<hr>
<b>Accuracy:</b><br> <span class="slidewrap" id="itslider">2500</span> iterations/point</br>
<span class="slidewraplt">&nbsp;</span><span class="slidewraprt" id="noslider">&nbsp;</span> <div class="jqslider" id="it-jsslider"></div><br>

</div>
</td>
</tr>
</table>


<p><span id="sweept"></span></p>
</center>

<script type="text/javascript">

var p = [];

function makeReadSlider(N)
{
    var R = document.getElementById("Rslider").innerHTML; 
    if(R > N)
    {
        R = N;
        document.getElementById("Rslider").innerHTML = R;
    }
   
    jQuery("#r-jsslider").slider({ min: 1, max: N, value: R, change: function(event, ui) { showR(ui.value); }  });
}


function makeWriteSlider(N)
{
    var W = document.getElementById("Wslider").innerHTML;
    if(W > N)
    {
        W = N;
        document.getElementById("Wslider").innerHTML = W;
    }

    jQuery("#w-jsslider").slider({ min: 1, max: N, value: W, change: function(event, ui) { showW(ui.value); }  });
}


  var loaded = false;

    document.observe('dom:loaded', function(){

    jQuery("#n-jsslider").slider({ min: 1, max: 9, value: 3, change: function(event, ui) { showN(ui.value); }  });
    jQuery("#k-jsslider").slider({ min: 1, max: 9, value: 1, change: function(event, ui) { showK(ui.value); }  });
    jQuery("#it-jsslider").slider({ min: 100, max: 15000, value: 2500, change: function(event, ui) { showIt(ui.value); }  });
    jQuery("#wl-jsslider").slider({ min: 10, max: 1500, value: 100, change: function(event, ui) { editWLambda(ui.value); }  });
    jQuery("#al-jsslider").slider({ min: 10, max: 1500, value: 100, change: function(event, ui) { editALambda(ui.value); }  });
    jQuery("#rl-jsslider").slider({ min: 10, max: 1500, value: 100, change: function(event, ui) { editRLambda(ui.value); }  });
    jQuery("#sl-jsslider").slider({ min: 10, max: 1500, value: 100, change: function(event, ui) { editSLambda(ui.value); }  });

    makeReadSlider(3);
    makeWriteSlider(3);
    editWLambda(100);
    editRLambda(100);
    editALambda(100);
    editSLambda(100);
    updateReadLatency();
    updateWriteLatency();
    loaded = true;
    updateProbability();
		       });

function updateReadLatency()
{
    var N = document.getElementById("Nslider").innerHTML;
    var R = document.getElementById("Rslider").innerHTML;
    var Rl = document.getElementById("rlambda").innerHTML;
    var Sl = document.getElementById("slambda").innerHTML;

    document.getElementById("rlatency").innerHTML = calculate_operation_latency(N, R, Rl, Sl);
}

function updateWriteLatency()
{
    var N = document.getElementById("Nslider").innerHTML;
    var W = document.getElementById("Wslider").innerHTML;
    var Wl = document.getElementById("wlambda").innerHTML;
    var Al = document.getElementById("alambda").innerHTML;

    document.getElementById("wlatency").innerHTML = calculate_operation_latency(N, W, Wl, Al);
}

function updateProbability()
{
    if(!loaded)
        return;

    var N = parseInt(document.getElementById("Nslider").innerHTML);
    var R = parseInt(document.getElementById("Rslider").innerHTML);
    var W = parseInt(document.getElementById("Wslider").innerHTML);
    var k = parseInt(document.getElementById("kslider").innerHTML);
    var Wl = document.getElementById("wlambda").innerHTML;
    var Al = document.getElementById("alambda").innerHTML;
    var Rl = document.getElementById("rlambda").innerHTML;
    var Sl = document.getElementById("slambda").innerHTML;

    var showtimes = [0, 10, 100];
    var st = 0;
    var resultHTML=""

    for(st = 0; st < showtimes.length; st++)
    {
	if(st != 0)
            resultHTML+="<br>"

	var thisps;

        if(R+W<= N)
	{
	    thisps = roundNumber(100*Math.min(MAX_PS,calc_prob_stale(N, R, W, Wl, Al, Rl, Sl, showtimes[st], k)), 2);
	    resultHTML+="You have at least a "+thisps+" percent chance of reading";
	}
	else
	{
	    thisps = 100;
	    resultHTML+="You are guaranteed to read";
        }

        if(k==1)
            resultHTML+=" the last written version";
	else
            resultHTML+=" one of the last "+k+" written versions";

        resultHTML+= " "+showtimes[st]+" ms after";

        if(k==1)
            resultHTML+=" it commits.";
	else
            resultHTML+=" they commit.";
    }

    document.getElementById("sweept").innerHTML = resultHTML;

    var ps_at_five = calc_prob_stale(N, R, W, Wl, Al, Rl, Sl, 5, k);
    var ps_at_ten = calc_prob_stale(N, R, W, Wl, Al, Rl, Sl, 10, k);

    var maxt = 30;
    var step = 2;

    if(ps_at_five > .99)
    {
       maxt = 5;
       step = .5;
    }
    else if(ps_at_ten > .99)
    {
       maxt = 10;
       step = 1;
    }
    p = [];
    for(var ts = 0; ts < maxt; ts+=step)
    { 
        var ps = calc_prob_stale(N, R, W, Wl, Al, Rl, Sl, ts, k);
        p.push([ts, ps]);
        if(ps > .9999 && p.length>5)
            break;
    }

    var f = Flotr.draw(
      $('tcdf'), 
      [ p ],
      {mouse:{
      track: true,
      lineColor: 'blue',
      sensibility: 1, // => The smaller this value, the more precise you've to point
      trackDecimals: 3,
      trackFormatter: function(obj){ return 't = ' + roundNumber(obj.x,2) +', Pr = ' + obj.y; }
      }}
      );
}

function showR(R)
{
    document.getElementById("Rslider").innerHTML=R;
    updateProbability();
    updateReadLatency();
}

function showN(N)
{
    document.getElementById("Nslider").innerHTML=N;
    if(document.getElementById("Rslider").innerHTML > N)
      showR(N);
    if(document.getElementById("Wslider").innerHTML > N)
      showW(N);

    makeReadSlider(N);
    updateReadLatency();

    makeWriteSlider(N);
    updateWriteLatency();
    updateProbability();
}

function showW(W)
{
    document.getElementById("Wslider").innerHTML=W;
    updateProbability();
    updateWriteLatency();
}

function showK(k)
{
    document.getElementById("kslider").innerHTML=k;
    updateProbability();
}

function showIt(its)
{
    document.getElementById("itslider").innerHTML=its;
    update_max_iterations(its);
    updateProbability();
}

function showT(t)
{
   document.getElementById("tslider").innerHTML=t;
   updateProbability();
}

function editLambda(lmbda, eleid, elecontainer)
{
	document.getElementById(eleid).innerHTML=(lmbda/1000).toFixed(3);
        var d1 = [];
        //for(var i = 0; i < Math.min(20000/lmbda, 300); i += 0.5)
	for(var i = 0; i < 32; i += 0.5)
		       d1.push([i, calc_exponential_cdf(lmbda/1000, i)]);
		   
		   var f = Flotr.draw($(elecontainer), [ d1 ], {xaxis: { tickDecimals: 0 }});
        updateProbability();
}


function editWLambda(wlambda)
{
        editLambda(wlambda, "wlambda", "wcontainer");
	updateWriteLatency();
}

function editALambda(alambda)
{
        editLambda(alambda, "alambda", "acontainer");
	updateWriteLatency();
}

function editRLambda(rlambda)
{
        editLambda(rlambda, "rlambda", "rcontainer");
	updateReadLatency();
}

function editSLambda(slambda)
{
        editLambda(slambda, "slambda", "scontainer");
	updateReadLatency();
}

</script>


<center>
<div id="latencypanel">
<b>Operation Latency</b><br/>
Exponentially Distributed CDFs</br>
<table cellpadding=10px  align="center">
<tr>
<td>
  <center>
    <span class="graph-label">Write Request to Replica</span>
    <div id="wcontainer" style="width:180px;height:100px;"></div>
    <span class="axis-label">Latency (ms)</span><br/>
    <span class="lambdalabel">&#x3BB;</span> <div class="lmbda-jqslider" id="wl-jsslider"></div><span id="wlambda">.100</span><br>
  </center>
</td>

<td>
  <center>
    <span class="graph-label">Replica Write Ack</span>
    <div id="acontainer" style="width:180px;height:100px;"></div>
    <span class="axis-label">Latency (ms)</span><br/>
    <span class="lambdalabel">&#x3BB;</span> <div class="lmbda-jqslider" id="al-jsslider"></div><span id="alambda">.100</span><br>
  </center>
</td>

<td align="center">
  <center>
    <span class="graph-label">Read Request to Replica</span>
    <div id="rcontainer" style="width:180px;height:100px;"></div>
    <span class="axis-label">Latency (ms)</span><br/>
    <span class="lambdalabel">&#x3BB;</span> <div class="lmbda-jqslider" id="rl-jsslider"></div><span id="rlambda">.100</span><br>
  </center>
</td>

<td align="center">
  <center>
    <span class="graph-label">Replica Read Response</span>
    <div id="scontainer" style="width:180px;height:100px;"></div>
    <span class="axis-label">Latency (ms)</span><br/>
    <span class="lambdalabel">&#x3BB;</span> <div class="lmbda-jqslider" id="sl-jsslider"></div><span id="slambda">.100</span><br>
  </center>
</td>
</tr>
</table>
</div>
</center>

</body>
